var filter={};function refresh(e=0){e=buildFilter(),getData("/api/chemical/totalUsage?"+$.param(e),doTotalUsage),getData("/api/chemical/totalUsageChart?"+$.param(e),doChart)}function buildFilter(){return filter.dateFrom=$("#dateFrom").val(),filter.dateTo=$("#dateTo").val(),filter.system=$("#system").val(),filter.plant=$("#plant").val(),filter.line=$("#line").val(),filter.object=$("#object").val(),filter.exception=$("#exception").val(),filter.chemical=$("#chemical").val(),filter.api_token=API_TOKEN,filter}function doTotalUsage(e){let t={},a={},l={},o={},r={};e.forEach(e=>{t[e["CIP System"]]=1,a[e["CIP Line"]]=1,l[e.Object]=1,o[e.ChemicalName]=e.usage,r[e.Plant]=1}),t=Object.keys(t).sort(),a=Object.keys(a).sort(),l=Object.keys(l).sort(),o=Object.keys(o).sort(),r=Object.keys(r).sort(),$("#plant").find("option").remove(),$("#plant").append($("<option>",{value:"",text:"All"})),r.forEach(e=>{$("#plant").append($("<option>",{value:e,text:e}))}),$('#plant option[value="'+filter.plant+'"]').attr("selected","selected"),$("#system").find("option").remove(),$("#system").append($("<option>",{value:"",text:"All"})),t.forEach(e=>{$("#system").append($("<option>",{value:e,text:e}))}),$('#system option[value="'+filter.system+'"]').attr("selected","selected"),$("#line").find("option").remove(),$("#line").append($("<option>",{value:"",text:"All"})),a.forEach(e=>{$("#line").append($("<option>",{value:e,text:e}))}),$('#line option[value="'+filter.line+'"]').attr("selected","selected"),$("#object").find("option").remove(),$("#object").append($("<option>",{value:"",text:"All"})),l.forEach(e=>{$("#object").append($("<option>",{value:e,text:e}))}),$('#object option[value="'+filter.object+'"]').attr("selected","selected"),$("#chemical").find("option").remove(),$("#chemical").append($("<option>",{value:"",text:"All"})),o.forEach(e=>{$("#chemical").append($("<option>",{value:e,text:e}))}),$('#chemical option[value="'+filter.chemical+'"]').attr("selected","selected"),$("#dtable").bootstrapTable({data:e}),$("#dtable").bootstrapTable("load",e)}function doChart(a){let t=[],l=[],o=(a.data.forEach(e=>{t[e.ChemicalName]=1,l[e.StartDateTime]=1}),t=Object.keys(t),l=Object.keys(l),[]);t.forEach(t=>{cdata=a.data.filter(e=>e.ChemicalName==t);var e={x:l,y:cdata.map(e=>e.usage),type:"scatter",name:t};o.push(e)});Plotly.newPlot("chrt",o,{responsive:!1,showlegend:!0,autosize:!0,height:310,margin:{l:40,r:60,b:30,t:10,pad:0}})}$(function(){$("#dateFrom").val(moment().subtract(2,"weeks").format("YYYY-MM-DD")),$("#dateTo").val(moment().format("YYYY-MM-DD")),refresh(0),$("#dateFrom").change(e=>{refresh(1)}),$("#dateTo").change(e=>{refresh(1)}),$("#system").change(e=>{refresh(1)}),$("#line").change(e=>{refresh(1)}),$("#plant").change(e=>{refresh(1)}),$("#object").change(e=>{refresh(1)}),$("#chemical").change(e=>{refresh(1)})});
