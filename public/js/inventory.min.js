var filter={};function refresh(e=0){e=buildFilter(),getData("/inventory/getList?"+$.param(e),doTotalUsage)}function buildFilter(){return filter.dateFrom=$("#dateFrom").val(),filter.dateTo=$("#dateTo").val(),filter.chemical=$("#chemical").val(),filter.plant=$("#plant").val(),filter}function buildForm(t){$f=$("#logForm");let l=Object.keys(t).length/2,o="",r="",c=0;Object.keys(t).forEach(e=>{var a='<div class="m-2 form-group row">',a=(a=(a+=`<div class="m-0 col-8" ><label for='chem_${t[e]}' class="m-0 col-form-label col-form-label-sm">${e}</label></div>`)+`<div class="m-0 col-2"><input type='number' class="m-0 form-control form-control-sm" name='chem_recvd_${t[e]}' placeholder='0.0'></div>`)+`<div class="m-0 col-2"><input type='number' class="m-0 form-control form-control-sm" name='chem_curr_${t[e]}' placeholder='0.0'></div>`+"</div>";c++<l?o+=a:r+=a});var e='<div class="m-2 row font-weight-bold border-bottom"><div class="m-0 col-8 " >Chemical</div><div class="m-0 col-2">Recvd</div><div class="m-0 col-2">Curr</div></div>';$f.html(`<div class="m-2 form-group row"><div class="col-sm"><label for="frmPlant" class="">Plant</label> <select name="frmPlant" id="frmPlant"></select> </div></div><div class='row'><div class='col-6' style="border-right: 1px solid #ccc;">${e}${o}</div><div class='col-6'>${e}${r}</div></div>`)}function saveLog(){let e=$("#logForm").serializeArray(),a={};e.forEach(e=>{a[e.name]=e.value}),$.post("/inventory/saveLog",a,function(e){console.log("data",e),refresh(1)}).fail(function(e){console.log("data",e)})}function doTotalUsage(e){let a={},t={};e.forEach(e=>{a[e.tblCip_Plants_id]=e.PlantName,t[e.chemical_name]=e.id}),buildForm(t),t=Object.keys(t).sort(),plantKeys=Object.keys(a).sort(),$("#chemical").find("option").remove(),$("#chemical").append($("<option>",{value:"",text:"All"})),t.forEach(e=>{$("#chemical").append($("<option>",{value:e,text:e}))}),$('#chemical option[value="'+filter.chemical+'"]').attr("selected","selected"),$("#plant").find("option").remove(),$("#frmPlant").find("option").remove(),$("#plant").append($("<option>",{value:"",text:"All"})),plantKeys.forEach(e=>{$("#plant").append($("<option>",{value:a[e],text:a[e]})),$("#frmPlant").append($("<option>",{value:e,text:a[e]}))}),$('#plant option[value="'+filter.plant+'"]').attr("selected","selected"),$("#dtable").bootstrapTable({data:e}),$("#dtable").bootstrapTable("load",e)}function doChart(t){let a=[],l=[],o=(t.data.forEach(e=>{a[e.ChemicalName]=1,l[e.StartDateTime]=1}),a=Object.keys(a),l=Object.keys(l),[]);a.forEach(a=>{cdata=t.data.filter(e=>e.ChemicalName==a);var e={x:l,y:cdata.map(e=>e.usage),type:"scatter",name:a};o.push(e)});Plotly.newPlot("chrt",o,{responsive:!1,showlegend:!0,autosize:!0,height:310,margin:{l:40,r:60,b:30,t:10,pad:0}})}$(function(){setupAjaxToken(),$("#dateFrom").val(moment().subtract(1,"weeks").format("YYYY-MM-DD")),$("#dateFrom").val("2022-06-01"),$("#dateTo").val(moment().format("YYYY-MM-DD")),refresh(0),$("#dateFrom").change(e=>{refresh(1)}),$("#dateTo").change(e=>{refresh(1)}),$("#chemical").change(e=>{refresh(1)}),$("#plant").change(e=>{refresh(1)})});
